{% extends "base.html" %}

{% block title %}Model Dashboard - FraudGuard AI{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-6">
    <!-- Dashboard Header -->
    <div class="dashboard-header mb-8">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="dashboard-title">Model Performance Dashboard</h1>
                <p class="dashboard-subtitle">Compare and analyze fraud detection models</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary" id="refreshDashboard">
                    <i data-lucide="refresh-cw"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Controls -->
    <div class="dashboard-controls card mb-6">
        <div class="card-body">
            {% if models and models|length > 0 %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="modelSelector" class="form-label">Select Model</label>
                            <select class="form-control" id="modelSelector">
                                <option value="">Choose a model...</option>
                                {% for model in models %}
                                    <option value="{{ model }}">{{ model.replace('_', ' ').title() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="comparisonMode" class="form-label">View Mode</label>
                            <select class="form-control" id="comparisonMode">
                                <option value="single">Single Model Analysis</option>
                                <option value="comparison">Compare All Models</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Export Options</label>
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary" id="exportPDF">
                                    <i data-lucide="file-text"></i> PDF
                                </button>
                                <button class="btn btn-outline-primary" id="exportExcel">
                                    <i data-lucide="download"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator d-none">
        <div class="loading-spinner"></div>
        <p>Loading model performance data...</p>
    </div>

    <!-- Performance Metrics Grid -->
    <div class="metric-grid mb-8" id="metricsCards">
        <div class="metric-card">
            <div class="metric-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="metric-value" id="rocAucValue">-</div>
            <div class="metric-label">ROC AUC</div>
            <div class="metric-description">Area Under Curve</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i data-lucide="target"></i>
            </div>
            <div class="metric-value" id="precisionValue">-</div>
            <div class="metric-label">Precision</div>
            <div class="metric-description">True Positive Rate</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i data-lucide="search"></i>
            </div>
            <div class="metric-value" id="recallValue">-</div>
            <div class="metric-label">Recall</div>
            <div class="metric-description">Fraud Detection Rate</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i data-lucide="activity"></i>
            </div>
            <div class="metric-value" id="f1Value">-</div>
            <div class="metric-label">F1 Score</div>
            <div class="metric-description">Harmonic Mean</div>
        </div>
    </div>

    <!-- Visualization Charts Section -->
    <div class="row mb-8">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Performance Comparison</h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Model Distribution</h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Importance Section -->
    <div class="row mb-8">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Feature Importance Analysis</h3>
                </div>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-canvas">
                            <canvas id="featureImportanceChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="feature-info">
                            <h4>Understanding Feature Importance</h4>
                            <ul>
                                <li><strong>V1-V28:</strong> PCA-transformed features from original transaction data</li>
                                <li><strong>Amount:</strong> Transaction monetary value</li>
                                <li><strong>Time:</strong> Seconds elapsed since first transaction</li>
                                <li>Higher values indicate stronger predictive power for fraud detection</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Performance Summary Table -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Performance Summary</h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-academic" id="performanceTable">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>ROC AUC</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1 Score</th>
                                <th>Accuracy</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model_name, model_metrics in metrics.items() %}
                                {% if model_metrics and 'error' not in model_metrics %}
                                    {% set fraud_metrics = model_metrics.classification_report.get('1', {}) %}
                                    <tr>
                                        <td><strong>{{ model_name.replace('_', ' ').title() }}</strong></td>
                                        <td>{{ "%.4f"|format(model_metrics.roc_auc_score) if model_metrics.roc_auc_score else 'N/A' }}</td>
                                        <td>{{ "%.4f"|format(fraud_metrics.precision) if fraud_metrics.precision else 'N/A' }}</td>
                                        <td>{{ "%.4f"|format(fraud_metrics.recall) if fraud_metrics.recall else 'N/A' }}</td>
                                        <td>{{ "%.4f"|format(fraud_metrics.get('f1-score', 0)) if fraud_metrics.get('f1-score') else 'N/A' }}</td>
                                        <td>{{ "%.4f"|format(model_metrics.classification_report.accuracy) if model_metrics.classification_report.accuracy else 'N/A' }}</td>
                                        <td><span class="badge badge-success">Active</span></td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td><strong>{{ model_name.replace('_', ' ').title() }}</strong></td>
                                        <td colspan="6" class="text-muted">{{ model_metrics.error if model_metrics else 'No data available' }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Models State -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="database"></i>
        </div>
        <h3>No Models Available</h3>
        <p>Please train some models first to view performance metrics.</p>
        <button class="btn btn-primary" onclick="trainModels()">
            <i data-lucide="play"></i> Train Models Now
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Professional Charts -->
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
// Initialize dashboard with available models and metrics (FIXED: tojson instead of tojsonfilter)
const availableModels = {{ models | tojson if models else '[]' }};
const initialMetrics = {{ metrics | tojson if metrics else '{}' }};

// Simple dashboard functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded with models:', availableModels);
    console.log('Initial metrics:', initialMetrics);
    
    // Refresh button
    document.getElementById('refreshDashboard')?.addEventListener('click', function() {
        window.location.reload();
    });
    
    // Export buttons (simple implementations)
    document.getElementById('exportPDF')?.addEventListener('click', function() {
        window.print();
    });
    
    document.getElementById('exportExcel')?.addEventListener('click', function() {
        alert('Excel export feature coming soon!');
    });
    
    // Initialize simple dashboard if we have models
    if (availableModels && availableModels.length > 0) {
        initializeSimpleDashboard();
    }
});

function initializeSimpleDashboard() {
    // Simple model selector handling
    const modelSelector = document.getElementById('modelSelector');
    if (modelSelector) {
        modelSelector.addEventListener('change', function() {
            const selectedModel = this.value;
            if (selectedModel && initialMetrics[selectedModel]) {
                updateMetricsDisplay(initialMetrics[selectedModel]);
            }
        });
    }
}

function updateMetricsDisplay(metrics) {
    if (!metrics || metrics.error) return;
    
    const fraudMetrics = metrics.classification_report?.['1'] || {};
    
    // Update metric cards
    updateElement('rocAucValue', metrics.roc_auc_score);
    updateElement('precisionValue', fraudMetrics.precision);
    updateElement('recallValue', fraudMetrics.recall);
    updateElement('f1Value', fraudMetrics['f1-score']);
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element && value !== undefined) {
        element.textContent = typeof value === 'number' ? value.toFixed(4) : value;
    }
}

function trainModels() {
    alert('Please run the training script:\npython main.py');
}

// Professional Charts Instance
let performanceChart = null;
let distributionChart = null;
let featureImportanceChart = null;

// Initialize Professional Charts
function initializeCharts() {
    if (typeof Chart === 'undefined' || !window.ProfessionalCharts) {
        console.error('Chart.js or ProfessionalCharts not loaded');
        return;
    }

    // Performance Comparison Chart
    if (initialMetrics && Object.keys(initialMetrics).length > 0) {
        performanceChart = window.ProfessionalCharts.createPerformanceChart('performanceChart', initialMetrics);
    }

    // Distribution Chart
    if (initialMetrics && Object.keys(initialMetrics).length > 0) {
        distributionChart = window.ProfessionalCharts.createDistributionChart('distributionChart', initialMetrics);
    }

    // Feature Importance Chart
    featureImportanceChart = window.ProfessionalCharts.createFeatureImportanceChart('featureImportanceChart');
}

// Call initialize charts when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Existing initialization
    console.log('Dashboard loaded with models:', availableModels);
    console.log('Initial metrics:', initialMetrics);
    
    // Initialize charts after a short delay to ensure Chart.js is loaded
    setTimeout(initializeCharts, 500);
    
    // Rest of existing code...
    // Initialize Lucide icons
    lucide.createIcons();
    
    document.getElementById('refreshDashboard')?.addEventListener('click', function() {
        window.location.reload();
    });
    
    document.getElementById('exportPDF')?.addEventListener('click', function() {
        window.print();
    });
    
    document.getElementById('exportExcel')?.addEventListener('click', function() {
        alert('Excel export feature coming soon!');
    });
    
    if (availableModels && availableModels.length > 0) {
        initializeSimpleDashboard();
    }
});
</script>
{% endblock %}